___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Measurelab Civic UK Cookie Control Banner Tag",
  "categories": [
    "ANALYTICS",
    "ADVERTISING",
    "UTILITY"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAFiUAABYlAUlSJPAAAAAZdEVYdFNvZnR3YXJlAEFkb2JlIEltYWdlUmVhZHlxyWU8AAAFSUlEQVR4Xu2bXWhbZRjH/zk5bdO0aZM27VrdENyFiOhQtnnhBwz8AB0Ov4XhJ4ypc7uYWNj8ZgWH1VG8GN0YbBciu5goKhN3IUy80JtdKeLXYK5duzZrmzQfS3o+fN7kbZos2Zq004edPr9QDu9zTs4Jz+/keZ83h/pcAgIbht4KTIgAZkQAMyKAGRHAjAhgRgQwIwKYEQHMiABmRAAzIoAZEcCMCGBGBDAjApgRAcyIAGZEADMigBkRwIwIYEYEMCMCmBEBzIgAZkQAMyKAGRHAjAhgRgQwIwKYEQHMiABmRAAzIoAZEcBMTf8lOeMkMWlNYMIaQdjfhajZQ9t2vXd5Y7k2YpSbcessjXxYYa5Cp9kF01fbvX1FASeT3+KL6YPIOgk6tfq6GHDh0MtFgy+Iu1o34enIlsLBy4zR2REcvrAXI7nfKR8W/LqY2DQy0ICVjTfhxegu9Ji9+fjlqCpgzDqHgbEdlPgpBI0QJd+ATxnQqHe49Mq5aWRp8HJXP9Y0r9d7vc9QrB+nUifQRlXAD5NyU5IcQqXUJilxewrrWx7Blmif3lNJhYDh3BnsGX2eTt4Gv69BRy+P4zqYssfxXMd7uCd0v456lz2jW6kUn0azj27MSxJfiYu0M4MuczXe7h3SsXLKCpVFyRw4/2rBbA3JVxhU6zr8K/DpZD+GZ8/oqDc5HBvIJz9otNWQfIUvf+z47F84cmGfjpVTJuBA7H0KOJR8U0dqQ30YJW3/+C4d8R5/Zn/DT6mv83d+vSgJPye/wunsHzoyT7EETVjn8da5JxE2ojXarSRlx7Ex/ApuCaylb9Osjl77NBlBHIq9gwSV2uo358L5stwcVYpV2N27X0cKFAUcmzqAH5NfIkAXWzwuMk4GtmvpsXdoNpprLsvVUGmesafxwcrP0e6P6GiJgL1j26ifPUv96+IvUkD1R96jcI8vrjLMkSQBL0TfxdrgvTpSMgdknRSdfmkXKKDO4r3XUpOv8FHDkqGuqJTalmvCVePShBfHrVSX1Bp3qaiK5sm/q1BY1Zqp1ejQowLFOeB4/DN8lzhCk039bdYc6lQX3Ywn54AGWvEW5sfKUlRL06hyk3QS+Pj6bxDwB3S0REDGSWPn8MNoMyKLakPVaWacKWzvHsTNgTU01js8gErH4Hgf/sn+ikZjPnn1kHMuYnXgdmzr6teRAsUS1Ezt54bQM7R0TuhIfcy6WdzQdGs++Qr1ob3yp3i2ow9pN5W/0epFvSdDlWFz5HUdmadsTngqshVh8zrMkq16cFwbWVpo7Oj+UEe8R6cZxWPh12gxNln3fBC3Y3g8vJ1yO9//z1HRBb3Zewg2/NSWpmm08IXUCi/uTOONniFapi/u63mt8EDbE1gXeggJK0Z39cINizpm2prAnaFNuK/tUR0tpzgHlEGRTyZ245fMDwj5w4WfXMmVmhvU4YVnAg5NKnF0mzdiZ/e+qna9ysnkcRyd/AiNNCk30k2nnpPMzZsqPyo3OSo5OcfG5s4+3N36YH5fNaoL0KiHDkcnBzFq/Y20naQ6n6HleCNaqFOKmL3Y2P4Sbmtep49efhybOohT6e9p3kwWF1jq+Yn68e2Olg1UdhZ+WHVFAaVYdFiGJugmXwt1AvX9WrocSDup/DZotOS3tVKzAOG/oWISFv5fRAAzIoAZEcCMCGBGBDAjApgRAcyIAGZEADMigBkRwIwIYEYEMCMCmBEBzIgAZkQAMyKAGRHAjAhgRgQwIwKYEQHMiABmRAAzIoAZEcCMCGBGBDAjApgRAcyIAGZEADMigBkRwIwIYAX4F9/QVgZSsj4pAAAAAElFTkSuQmCC"
  },
  "description": "The Measurelab Tag Template for deploying Civic UK\u0027s Cookie Control banner with Consent Mode directly through Google Tag Manager\nSee the header in the Code section for disclaimers.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "apiKey",
    "displayName": "Civic Cookie Control API Key",
    "simpleValueType": true,
    "help": "The API key of your Civic Cookie Control license.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "product",
    "displayName": "Product",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "COMMUNITY",
        "displayValue": "Community"
      },
      {
        "value": "CUSTOM",
        "displayValue": "Custom"
      },
      {
        "value": "PRO",
        "displayValue": "Pro"
      },
      {
        "value": "PRO_MULTISITE",
        "displayValue": "Pro Multisite"
      }
    ],
    "simpleValueType": true,
    "help": "The product corresponding to your Civic license\u0027s plan."
  },
  {
    "type": "GROUP",
    "name": "privacyStatement",
    "displayName": "Privacy Statement",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "privacyDescription",
        "displayName": "Privacy Policy Description",
        "simpleValueType": true,
        "help": "The text description that introduces your privacy policy."
      },
      {
        "type": "TEXT",
        "name": "privacyLabel",
        "displayName": "Privacy Policy Text Label",
        "simpleValueType": true,
        "help": "The text label that best describes your privacy policy and is included within the HTML link element."
      },
      {
        "type": "TEXT",
        "name": "privacyURL",
        "displayName": "Privacy Policy URL",
        "simpleValueType": true,
        "help": "The URL where your privacy policy may be publicly accessed. The HTML link element will try to open in a new tab, so it may point to a PDF document if you wish without closing the user\u0027s access to your site.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "privacyUpdated",
        "displayName": "Privacy Policy Issue Date",
        "simpleValueType": true,
        "help": "The date that your privacy policy was last issued, in the format of dd/mm/yyyy.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "REGEX",
            "args": [
              "^([0-2][0-9]|(3)[0-1])(\\/)(((0)[0-9])|((1)[0-2]))(\\/)\\d{4}$"
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "consentMode",
    "displayName": "Consent Mode Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SELECT",
        "name": "analyticsStorageDefault",
        "displayName": "analytics_storage",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "granted",
            "displayValue": "granted"
          },
          {
            "value": "denied",
            "displayValue": "denied"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied"
      },
      {
        "type": "SELECT",
        "name": "adStorageDefault",
        "displayName": "ad_storage",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "granted",
            "displayValue": "granted"
          },
          {
            "value": "denied",
            "displayValue": "denied"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied"
      },
      {
        "type": "SELECT",
        "name": "adUserDataDefault",
        "displayName": "ad_user_data",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "granted",
            "displayValue": "granted"
          },
          {
            "value": "denied",
            "displayValue": "denied"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied"
      },
      {
        "type": "SELECT",
        "name": "adPersonalizationDefault",
        "displayName": "ad_personalization",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "granted",
            "displayValue": "granted"
          },
          {
            "value": "denied",
            "displayValue": "denied"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied"
      },
      {
        "type": "TEXT",
        "name": "otherGrantedDefault",
        "displayName": "Additional granted storage types",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "otherDeniedDefault",
        "displayName": "Additional denied storage types",
        "simpleValueType": true
      },
      {
        "type": "CHECKBOX",
        "name": "urlPassthrough",
        "checkboxText": "Pass Ad Click Information Through URLs",
        "simpleValueType": true
      },
      {
        "type": "CHECKBOX",
        "name": "adsDataRedaction",
        "checkboxText": "Redact Ads Data",
        "simpleValueType": true
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "cookiesCategories",
    "displayName": "Cookie Categories",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "LABEL",
        "name": "necessaryCookiesLabel",
        "displayName": "Necessary Cookies"
      },
      {
        "type": "TEXT",
        "name": "necessaryCookies",
        "displayName": "Comma-delimited list of necessary cookie names",
        "simpleValueType": true,
        "valueValidators": [],
        "help": "The names of any necessary cookies that you wish to protect from being automatically wiped"
      },
      {
        "type": "LABEL",
        "name": "optionalCookiesLabel",
        "displayName": "Optional Cookies"
      },
      {
        "type": "PARAM_TABLE",
        "name": "optionalCookies",
        "displayName": "Optional Cookie Categories",
        "paramTableColumns": [
          {
            "param": {
              "type": "TEXT",
              "name": "optCatLabel",
              "displayName": "Label",
              "simpleValueType": true
            },
            "isUnique": true
          },
          {
            "param": {
              "type": "TEXT",
              "name": "optCatDescription",
              "displayName": "Description",
              "simpleValueType": true
            },
            "isUnique": true
          },
          {
            "param": {
              "type": "TEXT",
              "name": "optCatCookies",
              "displayName": "Cookies",
              "simpleValueType": true
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "TEXT",
              "name": "storage",
              "displayName": "Storage",
              "simpleValueType": true
            },
            "isUnique": false
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "global",
    "displayName": "Appearance \u0026 Behaviour",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SELECT",
        "name": "initialState",
        "displayName": "Initial State",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "open",
            "displayValue": "Open"
          },
          {
            "value": "closed",
            "displayValue": "Closed"
          },
          {
            "value": "notify",
            "displayValue": "Notify (Pro licenses only)"
          },
          {
            "value": "top",
            "displayValue": "Top (Pro licenses only)"
          },
          {
            "value": "box",
            "displayValue": "Box (Pro licenses only)"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "open"
      },
      {
        "type": "RADIO",
        "name": "rejectButton",
        "displayName": "Allow Reject Button?",
        "radioItems": [
          {
            "value": true,
            "displayValue": "Yes"
          },
          {
            "value": false,
            "displayValue": "No"
          }
        ],
        "simpleValueType": true,
        "defaultValue": false
      },
      {
        "type": "RADIO",
        "name": "layout",
        "displayName": "Display Style",
        "radioItems": [
          {
            "value": "slideout",
            "displayValue": "Slide out"
          },
          {
            "value": "popup",
            "displayValue": "Pop up"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "slideout"
      },
      {
        "type": "RADIO",
        "name": "position",
        "displayName": "Display Position",
        "radioItems": [
          {
            "value": "left",
            "displayValue": "Left"
          },
          {
            "value": "right",
            "displayValue": "Right"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "left"
      },
      {
        "type": "RADIO",
        "name": "theme",
        "displayName": "Theme",
        "radioItems": [
          {
            "value": "light",
            "displayValue": "Light"
          },
          {
            "value": "dark",
            "displayValue": "Dark"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "light"
      },
      {
        "type": "RADIO",
        "name": "toggleType",
        "displayName": "Control Toggle Type",
        "radioItems": [
          {
            "value": "slider",
            "displayValue": "Slider"
          },
          {
            "value": "checkbox",
            "displayValue": "Checkbox"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "slider"
      },
      {
        "type": "RADIO",
        "name": "acceptBehaviour",
        "displayName": "Cookie purposes that will be accepted when the user clicks \"Accept\"",
        "radioItems": [
          {
            "value": "all",
            "displayValue": "All"
          },
          {
            "value": "recommended",
            "displayValue": "Recommended"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "all"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "textArr",
    "displayName": "Text",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "textObj",
        "displayName": "Edit text object",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "String Property",
            "name": "stringProp",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "accept",
                "displayValue": "Accept Button (Notify Bar)"
              },
              {
                "value": "reject",
                "displayValue": "Reject Button (Notify Bar)"
              },
              {
                "value": "settings",
                "displayValue": "Settings"
              },
              {
                "value": "title",
                "displayValue": "Title (Main Panel)"
              },
              {
                "value": "intro",
                "displayValue": "Intro (Main Panel)"
              },
              {
                "value": "acceptSettings",
                "displayValue": "Accept Settings (Main Panel)"
              },
              {
                "value": "acceptRecommended",
                "displayValue": "Accept Recommended Settings"
              },
              {
                "value": "rejectSettings",
                "displayValue": "Reject Settings (Main Panel)"
              },
              {
                "value": "necessaryTitle",
                "displayValue": "Necessary Cookies Title"
              },
              {
                "value": "necessaryDescription",
                "displayValue": "Necessary Cookies Description"
              },
              {
                "value": "thirdPartyTitle",
                "displayValue": "Third Party Cookies Title"
              },
              {
                "value": "thirdPartyDescription",
                "displayValue": "Third Party Cookies Description"
              },
              {
                "value": "on",
                "displayValue": "On"
              },
              {
                "value": "off",
                "displayValue": "Off"
              },
              {
                "value": "notifyTitle",
                "displayValue": "Notify Title"
              },
              {
                "value": "notifyDescription",
                "displayValue": "Notify Description"
              },
              {
                "value": "closeLabel",
                "displayValue": "Close Label"
              },
              {
                "value": "cornerButton",
                "displayValue": "Corner Button"
              },
              {
                "value": "landmark",
                "displayValue": "Landmark (Screen Readers)"
              },
              {
                "value": "showVendors",
                "displayValue": "Show Vendors"
              },
              {
                "value": "thirdPartyCookies",
                "displayValue": "Third Party Cookies (Vendors)"
              },
              {
                "value": "readMore",
                "displayValue": "Read More (Vendors)"
              }
            ],
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "stringVal",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "brandingArr",
    "displayName": "Branding",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "brandingObj",
        "displayName": "Edit text object",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "String Property",
            "name": "stringProp",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "fontFamily",
                "displayValue": "fontFamily (font-family)"
              },
              {
                "value": "fontSizeTitle",
                "displayValue": "fontSizeTitle (font-size | h2 title)"
              },
              {
                "value": "fontSizeHeaders",
                "displayValue": "fontSizeHeaders (font-size | h3 titles)"
              },
              {
                "value": "fontSizeIntro",
                "displayValue": "fontSizeIntro (font-size | intro text)"
              },
              {
                "value": "fontSize",
                "displayValue": "fontSize (font-size | body text)"
              },
              {
                "value": "fontColor",
                "displayValue": "fontColor (color | all)"
              },
              {
                "value": "backgroundColor",
                "displayValue": "backgroundColor (background-color | all)"
              },
              {
                "value": "notifyFontColor",
                "displayValue": "notifyFontColor (color)"
              },
              {
                "value": "notifyBackgroundColor",
                "displayValue": "notifyBackgroundColor (background-color)"
              },
              {
                "value": "acceptText",
                "displayValue": "acceptText (color)"
              },
              {
                "value": "acceptBackground",
                "displayValue": "acceptBackground (background-color)"
              },
              {
                "value": "rejectText",
                "displayValue": "rejectText (color)"
              },
              {
                "value": "rejectBackground",
                "displayValue": "rejectBackground (background-color)"
              },
              {
                "value": "closeText",
                "displayValue": "closeText (color)"
              },
              {
                "value": "closeBackground",
                "displayValue": "closeBackground (background-color)"
              },
              {
                "value": "toggleText",
                "displayValue": "toggleText (color)"
              },
              {
                "value": "toggleColor",
                "displayValue": "toggleColor (color)"
              },
              {
                "value": "toggleBackground",
                "displayValue": "toggleBackground (background-color)"
              },
              {
                "value": "alertText",
                "displayValue": "alertText (color)"
              },
              {
                "value": "alertBackground",
                "displayValue": "alertBackground (background-color)"
              },
              {
                "value": "buttonIcon",
                "displayValue": "Button Icon URL"
              },
              {
                "value": "buttonIconWidth",
                "displayValue": "Button Icon pixel width"
              },
              {
                "value": "buttonIconHeight",
                "displayValue": "Button Icon pixel height"
              }
            ],
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "stringVal",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ]
      },
      {
        "type": "RADIO",
        "name": "removeIcon",
        "displayName": "Remove button icon?",
        "radioItems": [
          {
            "value": true,
            "displayValue": "Yes"
          },
          {
            "value": false,
            "displayValue": "No"
          }
        ],
        "simpleValueType": true,
        "defaultValue": false
      },
      {
        "type": "RADIO",
        "name": "removeAbout",
        "displayName": "Remove \u0027About this tool\u0027 link?",
        "radioItems": [
          {
            "value": true,
            "displayValue": "Yes"
          },
          {
            "value": false,
            "displayValue": "No"
          }
        ],
        "simpleValueType": true,
        "defaultValue": false
      }
    ],
    "enablingConditions": [
      {
        "paramName": "product",
        "paramValue": "COMMUNITY",
        "type": "NOT_EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "debug",
    "checkboxText": "Log debug messages to console",
    "simpleValueType": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

/*
 *  Measurelab does not own, maintain, update or have any legal claim to the
 *  Civic Cookie Control code base - nor as to the effectiveness of any
 *  particular implementation regarding compliance to the UK ICO’s directives
 *  and GDPR legislation. For information on how Civic Cookie Control works,
 *  and for updates on functionality please refer directly to Civics documentation
 *  which can be found here: https://www.civicuk.com/cookie-control/documentation/
 */


// Require the necessary APIs
const logToConsole = require('logToConsole');
const injectScript = require('injectScript');
const callInWindow = require('callInWindow');
const setInWindow = require('setInWindow');
const setDefaultConsentState = require('setDefaultConsentState');
const updateConsentState = require('updateConsentState');
const getCookieValues = require('getCookieValues');
const getUrl = require('getUrl');
const queryPermission = require('queryPermission');
const createQueue = require('createQueue');
const isConsentGranted = require('isConsentGranted');
const JSON = require('JSON');
const Object = require('Object');
const gtagSet = require('gtagSet');

// If the user chose to log debug output, initialize the logging method
const log = data.debug ? logToConsole : (() => {});

// Define data layer push method
const dataLayerPush = createQueue('dataLayer');

// Civic Cookie Control source URL
const url = 'https://cc.cdn.civiccomputing.com/9/cookieControl-9.x.min.js';

// Civic Cookie Control Cookie Name
const COOKIE_NAME = 'CookieControl';

log(data);

// Set default consent mode state(s)
const setDefault = () => {
  const defaultSettings = {};
  defaultSettings.analytics_storage = data.analyticsStorageDefault;
  defaultSettings.ad_storage = data.adStorageDefault;
  defaultSettings.ad_user_data = data.adUserDataDefault;
  defaultSettings.ad_personalization = data.adPersonalizationDefault;
  if (!!data.otherGrantedDefault) {
    splitInput(data.otherGrantedDefault).forEach( storage => defaultSettings[storage] = 'granted');
  }
  if (!!data.otherDeniedDefault) {
    splitInput(data.otherDeniedDefault).forEach( storage => defaultSettings[storage] = 'denied');
  }
  defaultSettings.wait_for_update = 500;
  setDefaultConsentState(defaultSettings);
  gtagSet({
    'url_passthrough': data.urlPassthrough || false,
    'ads_data_redaction': data.adsDataRedaction || false,
  });
};

// Check for existing Civic cookie settings
const checkCookie = () => {
  const settings = getCookieValues(COOKIE_NAME);
  if (typeof settings !== 'undefined' && (typeof settings === 'object' && settings.length > 0)) {
    const settingsObj = JSON.parse(settings[0]).optionalCookies;
    const optionalCookiesConfig = data.optionalCookies;
    
    // compare existing optional cookie category names
    const existingCategoryNames = Object.entries(settingsObj).map(e => e[0]).sort();
    const templateCategoryNames = optionalCookiesConfig.map(f => f.optCatLabel.toLowerCase().replace(' ','_').trim()).sort();
    if (!arraysEqual(existingCategoryNames, templateCategoryNames)) {
      log('Civic Computing: optionalCookie category names mismatched with existing CookieControl cookie. Deleting cookie and will prompt user to consent again.');
      if (queryPermission('access_globals', 'execute', 'CookieControl.delete')) {
        callInWindow('CookieControl.delete', COOKIE_NAME);
        return;
      } else {
        log('Civic Computing: CookieControl load failed due to permissions mismatch.');
        data.gtmOnFailure();
      }
    }
    const categoryDefinitions = {};
    if (!!optionalCookiesConfig) {
      optionalCookiesConfig.forEach(config => { categoryDefinitions[config.optCatLabel.toLowerCase().replace(' ','_').trim()] = config.storage; });
    }
    const updateObj = {};
    Object.entries(settingsObj).forEach(entry => {
      const categoryName = entry[0] || '';
      const consentState = entry[1] === 'accepted' ? 'granted' : 'denied';
      const storages = categoryDefinitions.hasOwnProperty(entry[0]) ? categoryDefinitions[entry[0]].split(',') : [];
      storages.forEach(storage => { updateObj[storage] = consentState; });
    });
    updateConsentState(updateObj);
  }
};

// Splits the input string using comma as a delimiter, returning an array of strings
const splitInput = (input) => {
  if (!input) {
    return [];
  }
  return input.split(',')
    .map(entry => entry.trim())
    .filter(entry => entry.length !== 0);
};

// Check if two (sorted) arrays are equal
const arraysEqual = (a, b) => {
  if (a === b) return true;
  if (a == null || b == null) return false;
  if (a.length !== b.length) return false;

  return a.every((val, idx) => val === b[idx]);
};

// Processes a row of input from the default settings table, returning an
// object which can be passed as an argument to setDefaultConsentState
const parseCommandData = (settings) => {
  const regions = splitInput(settings.region);
  const granted = splitInput(settings.granted);
  const denied = splitInput(settings.denied);
  const commandData = {};
  if (regions.length > 0) {
    commandData.region = regions;
  }
  granted.forEach(entry => {
    commandData[entry] = 'granted';
  });
  denied.forEach(entry => {
    commandData[entry] = 'denied';
  });
  return commandData;
};

setDefault();
checkCookie();

log('Civic Computing: Loading script from ' + url);

// If the script loaded successfully, log a message and signal success
const onSuccess = () => {
  loadCookieControl(config);
  log('Civic Computing: Script loaded successfully.');
  data.gtmOnSuccess();
};

// If the script fails to load, log a message and signal failure
const onFailure = () => {
  log('Civic Computing: Script load failed.');
  data.gtmOnFailure();
};

// Called when consent changes. Assumes that consent object contains keys which
// directly correspond to Google consent types.
const onUserConsent = (consent, state) => {
  log(consent);
  log(state);
  
  let consentStateChangeDetected = 0;
  if (!!consent && consent.length > 0) {
    for (let i = 0; i < consent.length; i++) {
      if ((!isConsentGranted(consent[i]) && state === 'granted') || (isConsentGranted(consent[i]) && state === 'denied')) {
        consentStateChangeDetected++;
      }
    }
  }
  
  if (consentStateChangeDetected === 0) {
    return;
  }
  
  let consentModeStates = {};
  consent.forEach((c) => {
    consentModeStates[c] = state;
  });
  
  updateConsentState(consentModeStates);
  dataLayerPush({
    'event': 'consentUpdate',
    'state': state,
    'cookie_type': consent.join(', '),
    'consent_type': 'update'
  });
};

// Load CookieControl with config
const loadCookieControl = (config) => {
  if (queryPermission('access_globals', 'execute', 'CookieControl.load')) {
    callInWindow('CookieControl.load', config);
  } else {
    log('Civic Computing: CookieControl load failed due to permissions mismatch.');
    data.gtmOnFailure();
  }
};

const optionalCookieCategories = (arr) => {
  log(arr);
  const optionalCookies = [];
  if (!!arr) {
    arr.forEach(category => {
      const obj = {};
      obj.name = category.optCatLabel.toLowerCase().replace(' ','_').trim();
      obj.label = category.optCatLabel;
      obj.description = category.optCatDescription;
      obj.cookies = category.optCatCookies.split(',');
      const args = category.storage.split(',');
      obj.onAccept = function () { onUserConsent(args, 'granted'); };
      obj.onRevoke = function () { onUserConsent(args, 'denied'); };
      log(obj);
      optionalCookies.push(obj);
    });
  }
  return optionalCookies;
};

// Civic config object
let config = {
  apiKey: data.apiKey,
  product: data.product,
  initialState: data.initialState,
  rejectButton: data.rejectButton,
  closeStyle: "button",
  layout: data.layout,
  position: data.position,
  theme: data.theme,
  toggleType: data.toggleType,
  acceptBehaviour: data.acceptBehaviour,
  statement: {
    description: data.privacyDescription,
    name: data.privacyLabel,
    url: data.privacyURL,
    updated: data.privacyUpdated
  },
  necessaryCookies: splitInput(data.necessaryCookies),
  optionalCookies: optionalCookieCategories(data.optionalCookies),
};

// Set banner initial state in config dependent on URL pathname
if (getUrl('path') == data.privacyURL) {
  config.initialState = 'closed';
} else {
  config.initialState = 'open';
}

// Build text object
if (data.textObj) {
  let text = {};
  data.textObj.forEach(i => {
    text[i.stringProp] = i.stringVal;
  });
  config.text = text;
}

// Build branding object
let branding = {
  removeIcon: data.removeIcon,
  removeAbout: data.removeAbout
};
if (data.brandingObj) {
  data.brandingObj.forEach(i => {
    branding[i.stringProp] = i.stringVal;
  });
}
config.branding = branding;

log(config);


// If the URL input by the user matches the permissions set for the template,
// inject the script with the onSuccess and onFailure methods as callbacks.
if (queryPermission('inject_script', url)) {
  injectScript(url, onSuccess, onFailure);
} else {
  log('Civic Computing: Script load failed due to permissions mismatch.');
  data.gtmOnFailure();
}

// Set config as global variable
if (queryPermission('access_globals', 'readwrite', 'config')) {
  setInWindow('config', config, true);
} else {
  log('Civic Computing: Setting config variable failed due to permissions mismatch.');
  data.gtmOnFailure();
}

// Call data.gtmOnSuccess when the tag is finished.
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "config"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "CookieControl.load"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "CookieControl.delete"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.civiccomputing.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "wait_for_update"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "CookieControl"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "url_passthrough"
              },
              {
                "type": 1,
                "string": "ads_data_redaction"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: setDefaultConsentState test
  code: |-
    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('setDefaultConsentState').wasCalledWith({
      analytics_storage: 'denied',
      ad_storage: 'granted',
      ad_user_data: 'granted',
      ad_personalization: 'denied',
      personalization_storage: 'granted',
      functionality_storage: 'granted',
      security_storage: 'denied',
      wait_for_update: 500
    });

    assertApi('gtmOnSuccess').wasCalled();
- name: updateConsentState test
  code: |-
    // Simulate getCookieValues function call result
    mock('getCookieValues', ['{"necessaryCookies":[],"optionalCookies":{"analytical_cookies":"accepted","marketing_cookies":"accepted","test":"accepted"},"statement":{"shown":true,"updated":"10/02/2022"},"consentDate":1703174608142,"consentExpiry":90,"interactedWith":true,"user":"C411DC12-1A6D-4F2B-9A52-883A58616A00"}']);

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('updateConsentState').wasCalledWith({
      ad_personalization: "granted",
      ad_storage: "granted",
      ad_user_data: "granted",
      analytics_storage: "granted",
      security_storage: "granted"
    });

    assertApi('gtmOnSuccess').wasCalled();
setup: |-
  const mockData = {
    // Mocked field values
    analyticsStorageDefault: 'denied',
    adStorageDefault: 'granted',
    adUserDataDefault: 'granted',
    adPersonalizationDefault: 'denied',
    otherGrantedDefault: 'functionality_storage,personalization_storage',
    otherDeniedDefault: 'security_storage',
    urlPassthrough: true,
    adsDataRedaction: true,
    optionalCookies:[
      {"optCatLabel":"Analytical Cookies","optCatDescription":"Analytical cookies help us to improve our website by collecting and reporting information on its usage.","optCatCookies":"a,b,c","storage":"analytics_storage"},
      {"optCatLabel":"Marketing Cookies","optCatDescription":"We use marketing cookies to help us improve the relevancy of advertising campaigns you receive.","optCatCookies":"d,e,f","storage":"ad_storage,ad_user_data,ad_personalization"},
      {"optCatLabel":"Test","optCatDescription":"test category","optCatCookies":"g,h,i","storage":"security_storage"}
    ],
  };


___NOTES___

Created on 08/12/2023, 15:32:47


